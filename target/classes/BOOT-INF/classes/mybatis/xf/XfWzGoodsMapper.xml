<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.xf.mapper.XfWzGoodsMapper">

    <resultMap type="com.ruoyi.project.xf.domain.XfWzGoods" id="XfWzGoodsResult">
        <result property="id" column="id"/>
        <result property="goodsCode" column="goods_code"/>
        <result property="siteId" column="site_id"/>
        <result property="goodsName" column="goods_name"/>
        <result property="manufactor" column="manufactor"/>
        <result property="supplier" column="supplier"/>
        <result property="typeId" column="type_id"/>
        <result property="state" column="state"/>
        <result property="model" column="model"/>
        <result property="num" column="num"/>
        <result property="unit" column="unit"/>
        <result property="getTime" column="get_time"/>
        <result property="limitTime" column="limit_time"/>
        <result property="useTime" column="use_time"/>
        <result property="bz" column="bz"/>
        <result property="siteAddress" column="site_address"/>
        <result property="siteName" column="siteName"/>
        <result property="typeName" column="typeName"/>
        <result property="damageNum" column="damage_num"/>
        <result property="version" column="version"/>
    </resultMap>

    <resultMap type="com.ruoyi.project.xf.domain.XfWzGoodsExcel" id="XfWzGoodsExcelResult">
        <result property="id" column="id"/>
        <result property="goodsCode" column="goods_code"/>
        <result property="siteId" column="site_id"/>
        <result property="goodsName" column="goods_name"/>
        <result property="manufactor" column="manufactor"/>
        <result property="supplier" column="supplier"/>
        <result property="typeId" column="type_id"/>
        <result property="state" column="state"/>
        <result property="model" column="model"/>
        <result property="num" column="num"/>
        <result property="unit" column="unit"/>
        <result property="getTime" column="get_time"/>
        <result property="limitTime" column="limit_time"/>
        <result property="useTime" column="use_time"/>
        <result property="bz" column="bz"/>
        <result property="siteAddress" column="site_address"/>
        <result property="siteName" column="siteName"/>
        <result property="typeName" column="typeName"/>
        <result property="damageNum" column="damage_num"/>
        <result property="ruleName" column="ruleName"/>
    </resultMap>

    <resultMap type="com.ruoyi.project.xf.domain.GoodsDetail" id="GoodsDetailResult">
        <result property="id" column="id"/>
        <result property="goodsCode" column="goods_code"/>
        <result property="siteId" column="site_id"/>
        <result property="goodsName" column="goods_name"/>
        <result property="manufactor" column="manufactor"/>
        <result property="supplier" column="supplier"/>
        <result property="typeId" column="type_id"/>
        <result property="state" column="state"/>
        <result property="remarks" column="remarks"/>
        <result property="goodsName" column="goods_name"/>
        <result property="siteAddress" column="site_address"/>
        <result property="siteName" column="site_name"/>
    </resultMap>

    <sql id="selectXfWzGoodsVo">
        select id,
               goods_code,
               site_id,
               goods_name,
               manufactor,
               supplier,
               type_id,
               state,
               model,
               num,
               unit,
               get_time,
               limit_time,
               use_time,
               bz
        from xf_wz_goods
    </sql>

    <sql id="selectXfWzGoodsSiteVo">
        select goods.id,
               goods_code,
               goods.site_id,
               goods_name,
               manufactor,
               supplier,
               type_id,
               goods.state,
               site.site_name,
               site.site_address
        from xf_wz_goods goods
                 LEFT JOIN xf_base_site site ON site.id = goods.site_id
    </sql>

    <sql id="selectXfWzGoodsSiteDetailVo">
        select goods.id,
               goods_code,
               goods.site_id,
               goods_name,
               goods.supplier,
               manufactor,
               type_id,
               goods.state,
               site.site_name   as siteName,
               site.site_address,
               model,
               num,
               unit,
               get_time,
               limit_time,
               bz,
               use_time,
               damage_num,
               wzType.type_name as typeName,
               version
        from xf_wz_goods goods
                 LEFT JOIN xf_base_site site ON site.id = goods.site_id
                 LEFT JOIN xf_wz_type wzType ON wzType.id = goods.type_id
    </sql>

    <select id="selectXfWzTypeCount" resultType="com.ruoyi.project.xf.domain.XfWzInventoryNum">
        SELECT
        sum(case when damage_num > 0 then (num-damage_num)
        else (num) end) as totalNum from xf_wz_goods where state=2 and num+0>0
        <if test="wxtypeId != null ">and type_id = #{wxtypeId}</if>
        <if test="siteId != null ">and site_id = #{siteId}</if>
    </select>

    <select id="selectXfWzTypeList" resultType="com.ruoyi.project.xf.domain.XfWzGoods">
        select id,num,damage_num as damageNum from xf_wz_goods where state=2 and num+0>0
        <if test="wxtypeId != null ">and type_id = #{wxtypeId}</if>
        <if test="siteId != null ">and site_id = #{siteId}</if>
    </select>

    <select id="count" parameterType="long" resultType="int">
        select count(*)
        from xf_wz_goods
    </select>

    <select id="totalGoosByTypeIds" parameterType="long" resultType="int">
        select count(*) from xf_wz_goods
        WHERE type_id in
        <foreach collection="typeIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="queryListByIds" resultMap="XfWzGoodsResult">
        select goods.id, goods.site_id, site.site_name as siteName,site.site_address as siteAddress
        from xf_wz_goods goods
        LEFT JOIN xf_base_site site ON site.id= goods.site_id
        WHERE goods.id IN
        <foreach collection="goodsIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="queryObjectByGoodsCode" resultMap="XfWzGoodsResult">
        <include refid="selectXfWzGoodsVo"/>
        WHERE goods_code = #{goodsCode}
    </select>

    <select id="selectXfWzCal" resultType="com.ruoyi.project.xf.domain.XfWzGoodsCal">
        SELECT SUM(CASE WHEN (goods.state=2 or goods.state=4) then goods.num ELSE 0 end) totalNum,
        SUM(CASE WHEN (goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)) then goods.num - goods.damage_num ELSE 0 end) onworkNum,
        SUM(CASE WHEN goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3) then 1 ELSE 0 end) repairNum,
        SUM( goods.damage_num) reportlossNum
        from xf_wz_goods goods LEFT JOIN xf_wx_repair repair ON goods.id = `repair`.goods_id and (`repair`.repair_state in (1,2,3) or repair.available_flag=2)
        WHERE goods.state!=1

        <if test="siteId != null  and siteId != ''">and goods.site_id=#{siteId}</if>
        <if test="typeId != null  and typeId != ''">and goods.type_id=#{typeId}</if>

        <if test="province != null  and province != ''">and goods.site_id in ( SELECT id from xf_base_site where province= #{province}
            <if test="city != null  and city != ''">and city = #{city}</if>
            <if test="area != null  and area != ''">and area = #{area}</if>
            <if test="street != null  and street != ''">and street = #{street}</if>
            )
        </if>

        <if test="state != null  and state == 2">and goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)</if>
        <if test="state != null  and state == 3">and goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)</if>
        <if test="state != null  and state == 4">and (goods.state=4 or (goods.num > 0 and goods.damage_num > 0))</if>

    </select>

    <!-- ,
        CASE WHEN (goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)) then 3 WHEN (goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)) THEN 2
          WHEN (goods.state=4 or (goods.num > 0 and goods.damage_num > 0)) then 4 else 0 end as state -->
    <select id="selectXfWzGoodsListPage" resultType="com.ruoyi.project.xf.domain.XfWzGoodsCalSimple">
        SELECT goods.id,goods.goods_code as goodsCode,goods.goods_name as goodsName,site.site_name as siteName,wzType.type_name as typeName,CASE WHEN repair.available_flag=2 THEN 0
        ELSE goods.num END as num,goods.damage_num as damageNum
        from xf_wz_goods goods LEFT JOIN xf_wx_repair repair ON goods.id = `repair`.goods_id and (`repair`.repair_state in (1,2,3) or repair.available_flag=2)
        LEFT JOIN xf_base_site site ON site.id=goods.site_id
        LEFT JOIN xf_wz_type wzType ON wzType.id=goods.type_id
        WHERE goods.state!=1
        <if test="siteId != null  and siteId != ''">and goods.site_id=#{siteId}</if>
        <if test="typeId != null  and typeId != ''">and goods.type_id=#{typeId}</if>
        <if test="province != null  and province != ''">and goods.site_id in ( SELECT id from xf_base_site where province= #{province}
            <if test="city != null  and city != ''">and city = #{city}</if>
            <if test="area != null  and area != ''">and area = #{area}</if>
            <if test="street != null  and street != ''">and street = #{street}</if>
            )
        </if>
        <if test="state != null  and state == 2">and goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)</if>
        <if test="state != null  and state == 3">and goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)</if>
        <if test="state != null  and state == 4">and (goods.state=4 or (goods.num > 0 and goods.damage_num > 0))</if>
        ORDER BY goods.id DESC
        LIMIT #{page},#{limit}
    </select>

    <select id="selectXfWzGoodsListNoPage" resultType="com.ruoyi.project.xf.domain.WzGoodsExport">
        SELECT goods.id,goods.goods_code goodsCode,goods.goods_name goodsName,site.site_name siteName,site.site_address siteAddress,wzType.type_name typeName,
        goods.model,goods.num,goods.damage_num as damageNum,goods.unit,goods.get_time getTime,goods.limit_time limitTime,goods.use_time
        useTime,goods.manufactor,goods.supplier,goods.bz,
        CASE WHEN (goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)) then '报修中' WHEN (goods.state=2 and (repair.available_flag is null or
        repair.available_flag!=2)) THEN '正常'
        WHEN (goods.state=4 or (goods.num > 0 and goods.damage_num > 0)) then '已报损' else '' end as goodsState
        from xf_wz_goods goods LEFT JOIN xf_wx_repair repair ON goods.id = `repair`.goods_id and (`repair`.repair_state in (1,2,3) or repair.available_flag=2)
        LEFT JOIN xf_base_site site ON site.id=goods.site_id
        LEFT JOIN xf_wz_type wzType ON wzType.id=goods.type_id
        WHERE goods.state!=1
        <if test="siteId != null  and siteId != ''">and goods.site_id=#{siteId}</if>
        <if test="typeId != null  and typeId != ''">and goods.type_id=#{typeId}</if>
        <if test="province != null  and province != ''">and goods.site_id in ( SELECT id from xf_base_site where province= #{province}
            <if test="city != null  and city != ''">and city = #{city}</if>
            <if test="area != null  and area != ''">and area = #{area}</if>
            <if test="street != null  and street != ''">and street = #{street}</if>
            )
        </if>
        <if test="state != null  and state == 2">and goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)</if>
        <if test="state != null  and state == 3">and goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)</if>
        <if test="state != null  and state == 4">and (goods.state=4 or (goods.num > 0 and goods.damage_num > 0))</if>
        <if test="goodsName != null">
            and goods.goods_name in
            <foreach collection="goodsName" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        ORDER BY goods.id DESC
    </select>

    <select id="selectXfWzGoodsByCode" parameterType="String" resultMap="GoodsDetailResult">
        <include refid="selectXfWzGoodsSiteVo"/>
        WHERE goods_code = #{goodsCode}
    </select>

    <select id="selectXfWzGoodsDetailById" parameterType="Long" resultMap="XfWzGoodsResult">
        <include refid="selectXfWzGoodsSiteDetailVo"/>
        where goods.id = #{id}
    </select>

    <sql id="selectXfWzGoodsVoByWeb">
        select goods.id,
               goods.goods_code,
               goods.site_id,
               goods.goods_name,
               goods.model,
               goods.manufactor,
               goods.supplier,
               goods.type_id,
               goods.state,
               goods.num,
               goods.damage_num,
               goods.unit,
               goods.get_time,
               goods.limit_time,
               goods.use_time,
               site.site_name   AS siteName,
               wzType.type_name as typeName,
               rule.name        as ruleName
        from xf_wz_goods goods
                 LEFT JOIN xf_base_site site ON site.id = goods.site_id
                 LEFT JOIN xf_wz_type wzType ON wzType.id = goods.type_id
                 left outer join xf_goods_maintain_bind as bind on bind.goods_id = goods.id
                 left outer join xf_maintian_goods_rule as rule on bind.maintain_rule_id = rule.id
    </sql>


    <select id="selectXfWzGoodsList" resultMap="XfWzGoodsExcelResult">
        <include refid="selectXfWzGoodsVoByWeb"/>
        <where>
            <if test="goodsCode != null  and goodsCode != ''">and goods.goods_code = #{goodsCode}</if>
            <if test="siteId != null ">and goods.site_id = #{siteId}</if>
            <if test="goodsName != null  and goodsName != ''">and goods.goods_name like concat('%', #{goodsName}, '%')</if>
            <if test="manufactor != null  and manufactor != ''">and goods.manufactor like concat('%', #{manufactor}, '%')</if>
            <if test="supplier != null  and supplier != ''">and goods.supplier like concat('%', #{supplier}, '%')</if>
            <if test="typeId != null ">and goods.type_id = #{typeId}</if>
            <if test="state != null ">and goods.state = #{state}</if>
            <if test="typeName != null ">and wzType.type_name like concat('%', #{typeName}, '%')</if>
            <if test="siteName != null ">and site.site_name like concat('%', #{siteName}, '%')</if>
        </where>
        ORDER BY goods.id DESC
    </select>

    <select id="queryListByName" resultType="com.ruoyi.project.xf.domain.XfWzGoodsSimple">
        select DISTINCT goods.goods_name goodsName, goods.model, goods.manufactor, goods.num,goods.unit,get_time as getTime,limit_time as limitTime,use_time as useTime, bz
        from xf_wz_goods goods
        where goods.state=2
        <if test="goodsCode != null  and goodsCode != ''">and goods.goods_code = #{goodsCode}</if>
        <if test="siteId != null ">and goods.site_id = #{siteId}</if>
        <if test="goodsName != null  and goodsName != ''">and goods.goods_name like concat('%', #{goodsName}, '%')</if>
        <if test="manufactor != null  and manufactor != ''">and goods.manufactor like concat('%', #{manufactor}, '%')</if>
        <if test="supplier != null  and supplier != ''">and goods.supplier like concat('%', #{supplier}, '%')</if>
        <if test="typeId != null ">and goods.type_id = #{typeId}</if>
        <if test="state != null ">and goods.state = #{state}</if>
        ORDER BY goods.id DESC
        limit 0,10
    </select>

    <select id="searchNoInWzByCode" resultType="com.ruoyi.project.xf.domain.XfWzGoodsSimple">
        select goods.id,
               goods.goods_code     goodsCode,
               goods.goods_name     goodsName,
               goods.model,
               goods.manufactor,
               goods.supplier,
               goods.num,
               goods.unit,
               goods.state,
               site.site_name    AS siteName,
               site.site_address AS siteAddress,
               wzType.type_name  as TypeName,
               goods.site_id     AS siteId,
               goods.type_id     AS typeId
        from xf_wz_goods goods
                 LEFT JOIN xf_base_site site ON site.id = goods.site_id
                 LEFT JOIN xf_wz_type wzType ON wzType.id = goods.type_id
        where goods.goods_code = #{goodsCode}
    </select>

    <sql id="queryGoodsByIds">
        select id,
               goods_code,
               goods_name,
               model,
               num,
               unit,
               get_time,
               state,
               type_id,
               limit_time,
               use_time
        from xf_wz_goods
    </sql>
    <select id="queryGoodsByIds" parameterType="Long" resultMap="XfWzGoodsResult">
        <include refid="queryGoodsByIds"/>

        <if test="goodsIds != null">
            where id IN
            <foreach collection="goodsIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

    </select>

    <select id="selectXfWzGoodsById" parameterType="Long" resultMap="XfWzGoodsResult">
        <include refid="selectXfWzGoodsVo"/>
        where id = #{id}
    </select>

    <select id="selectXfWzGoodsFullInfoById" resultMap="XfWzGoodsResult">
        <include refid="selectXfWzGoodsVoByWeb"/>
        where goods.id = #{id}
    </select>

    <insert id="insertXfWzGoods" parameterType="XfWzGoods" useGeneratedKeys="true" keyProperty="id">
        insert into xf_wz_goods
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="goodsCode != null  and goodsCode != ''">goods_code,</if>
            <if test="siteId != null ">site_id,</if>
            <if test="goodsName != null  and goodsName != ''">goods_name,</if>
            <if test="manufactor != null  and manufactor != ''">manufactor,</if>
            <if test="supplier != null  and supplier != ''">supplier,</if>
            <if test="typeId != null ">type_id,</if>
            <if test="state != null ">state,</if>
            <if test="model != null ">model,</if>
            <if test="num != null ">num,</if>
            <if test="unit != null ">unit,</if>
            <if test="getTime != null ">get_time,</if>
            <if test="limitTime != null ">limit_time,</if>
            <if test="useTime != null ">use_time,</if>
            <if test="bz != null ">bz,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="goodsCode != null  and goodsCode != ''">#{goodsCode},</if>
            <if test="siteId != null ">#{siteId},</if>
            <if test="goodsName != null  and goodsName != ''">#{goodsName},</if>
            <if test="manufactor != null  and manufactor != ''">#{manufactor},</if>
            <if test="supplier != null  and supplier != ''">#{supplier},</if>
            <if test="typeId != null ">#{typeId},</if>
            <if test="state != null ">#{state},</if>
            <if test="model != null ">#{model},</if>
            <if test="num != null ">#{num},</if>
            <if test="unit != null ">#{unit},</if>
            <if test="getTime != null ">#{getTime},</if>
            <if test="limitTime != null ">#{limitTime},</if>
            <if test="useTime != null ">#{useTime},</if>
            <if test="bz != null ">#{bz},</if>
        </trim>
    </insert>

    <insert id="saveBatch" parameterType="XfWzGoods">
        insert into xf_wz_goods
        (goods_code,site_id,goods_name,manufactor,supplier,type_id,state,model,num,unit,get_time,limit_time,use_time,bz)
        VALUES
        <foreach collection="goodsList" item="item" separator=",">
            (#{item.goodsCode},#{item.siteId},#{item.goodsName},#{item.manufactor},#{item.supplier},#{item.typeId},#{item.state},
            #{item.model},#{item.num},#{item.unit},#{item.getTime},#{item.limitTime},#{item.useTime},#{item.bz})
        </foreach>
    </insert>


    <select id="getCountByWriteLock" resultType="java.lang.Integer">
        select count(1)
        from xf_wz_goods for
        update
    </select>

    <select id="searchKeyword" resultMap="XfWzGoodsResult" parameterType="com.ruoyi.project.xcx.request.SearchKeywordRequest">
        SELECT distinct

        <if test="goodsName != null and goodsName != '' ">
            goods_name
        </if>

        <if test="model != null and model != '' ">
            model
        </if>

        <if test="manufactor != null and manufactor != '' ">
            manufactor
        </if>

        <if test="supplier != null and supplier != '' ">
            supplier
        </if>

        FROM xf_wz_goods

        <where>

            <if test="goodsName != null and goodsName != ''">
                goods_name LIKE concat(#{goodsName}, '%')
            </if>

            <if test="model != null and model != ''">
                model LIKE concat(#{model}, '%')
            </if>

            <if test="manufactor != null and manufactor != ''">
                manufactor LIKE concat(#{manufactor}, '%')
            </if>

            <if test="supplier != null and supplier != ''">
                supplier LIKE concat(#{supplier}, '%')
            </if>

            AND state = 2
        </where>
        limit 0,5
    </select>

    <select id="selectCountByCodes" resultType="java.lang.Integer">
        select count(1)
        from xf_wz_goods
        where goods_code = #{goodsCode}
    </select>

    <select id="selectSupplierByGoodsId" resultType="java.lang.String">
        select supplier
        from xf_wz_goods
        where id = #{goodsId};
    </select>

    <select id="supplierList" resultType="java.lang.String">
        select distinct supplier
        from xf_wz_goods
        where supplier is not null
    </select>

    <select id="selectGoodsListByNameAllLike" resultType="java.lang.String">
        select distinct goods_name
        from xf_wz_goods
        where goods_name like concat('%', #{goodsName}, '%')
          and `state` = 2
    </select>

    <select id="selectGoodsNameListBySiteId" resultType="java.lang.String">
        select distinct goods_name
        from xf_wz_goods
        where goods_name like concat('%', #{goodsName}, '%')
          and site_id = #{siteId}
    </select>

    <select id="selectGoodsNameListBySiteIds" resultType="java.lang.String">
        select distinct goods_name
        from xf_wz_goods
        where goods_name like concat('%', #{goodsName}, '%')
        and site_id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectTypeGoodsListByNameAllWithLike" resultType="java.lang.String">
        select goods_name
        from xf_wz_goods
        where type_id = #{type}
          and goods_name like concat('%', #{goodsName}, '%')
          and `state` = 2
    </select>

    <select id="selectGoodsStatisticsByGoodsNamesAndSiteId" resultType="com.ruoyi.project.xf.domain.XfWzGoodsCalSimple">
        SELECT goods.id as id ,
        goods.goods_code as goodsCode,
        goods.goods_name as goodsName,
        site.site_name as siteName,
        wzType.type_name as typeName,
        CASE WHEN repair.available_flag=2 THEN 0 ELSE goods.num END num,
        goods.damage_num as damageNum,
        goods.unit
        from xf_wz_goods goods
        LEFT JOIN xf_wx_repair repair ON goods.id = `repair`.goods_id and (`repair`.repair_state in (1,2,3) or repair.available_flag=2)
        LEFT JOIN xf_base_site site ON site.id=goods.site_id
        LEFT JOIN xf_wz_type wzType ON wzType.id=goods.type_id
        WHERE goods.state != 1
        <if test="state != null  and state == 2">and goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)</if>
        <if test="state != null  and state == 3">and goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)</if>
        <if test="state != null  and state == 4">and (goods.state=4 or (goods.num > 0 and goods.damage_num > 0))</if>
        /* 调用该方法需要注意goodsNameList不可以是空或者空集合 */
        and goods_name in
        <foreach collection="goodsNameList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and goods.site_id = #{siteId}
        ORDER BY goods.id DESC
    </select>

    <select id="selectGoodsStatisticsByGoodsNamesAndSiteIds" resultType="com.ruoyi.project.xf.domain.XfWzGoodsCalSimple">
        SELECT goods.id as id ,
        goods.goods_code as goodsCode,
        goods.goods_name as goodsName,
        site.site_name as siteName,
        wzType.type_name as typeName,
        CASE WHEN repair.available_flag=2 THEN 0 ELSE goods.num END num,
        goods.damage_num as damageNum,
        goods.unit
        from xf_wz_goods goods
        LEFT JOIN xf_wx_repair repair ON goods.id = `repair`.goods_id and (`repair`.repair_state in (1,2,3) or repair.available_flag=2)
        LEFT JOIN xf_base_site site ON site.id=goods.site_id
        LEFT JOIN xf_wz_type wzType ON wzType.id=goods.type_id
        WHERE goods.state != 1
        <if test="state != null  and state == 2">and goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)</if>
        <if test="state != null  and state == 3">and goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)</if>
        <if test="state != null  and state == 4">and (goods.state=4 or (goods.num > 0 and goods.damage_num > 0))</if>
        /* 调用该方法需要注意goodsNameList不可以是空或者空集合 */
        and goods_name in
        <foreach collection="goodsNameList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and goods.site_id in
        <foreach collection="siteIdList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        ORDER BY goods.id DESC
    </select>

    <select id="selectGoodsStatisticsNumByGoodsName" resultType="com.ruoyi.project.xf.domain.XfWzGoodsCal">
        SELECT
        /* 总数量 */
        SUM(CASE WHEN (goods.state=2 or goods.state=4) then goods.num ELSE 0 end) totalNum,
        /* 正常物资数量 */
        SUM(CASE WHEN (goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)) then goods.num - goods.damage_num ELSE 0 end) onworkNum,
        /* 报修数量 */
        SUM(CASE WHEN (goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)) then 1 ELSE 0 end) repairNum,
        /* 损坏数量 */
        SUM(goods.damage_num) reportlossNum

        from xf_wz_goods goods

        LEFT JOIN xf_wx_repair repair ON goods.id = `repair`.goods_id and `repair`.repair_state in (1,2,3)

        WHERE goods.state!=1

        and goods.site_id=#{siteId}

        <if test="state != null  and state == 2">and goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)</if>
        <if test="state != null  and state == 3">and goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)</if>
        <if test="state != null  and state == 4">and (goods.state=4 or (goods.num > 0 and goods.damage_num > 0))</if>

        and goods.goods_name in
        <foreach collection="goodsNameList" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="selectGoodsStatisticsNumByGoodsNameAndSiteIds" resultType="com.ruoyi.project.xf.domain.XfWzGoodsCal">
        SELECT
        /* 总数量 */
        SUM(CASE WHEN (goods.state=2 or goods.state=4) then goods.num ELSE 0 end) totalNum,
        /* 正常物资数量 */
        SUM(CASE WHEN (goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)) then goods.num - goods.damage_num ELSE 0 end) onworkNum,
        /* 报修数量 */
        SUM(CASE WHEN (goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)) then 1 ELSE 0 end) repairNum,
        /* 损坏数量 */
        SUM(goods.damage_num) reportlossNum

        from xf_wz_goods goods

        LEFT JOIN xf_wx_repair repair ON goods.id = `repair`.goods_id and (`repair`.repair_state in (1,2,3) or repair.available_flag=2)

        WHERE goods.state!=1

        <if test="state != null  and state == 2">and goods.state=2 and (repair.available_flag is null or repair.available_flag!=2)</if>
        <if test="state != null  and state == 3">and goods.state=2 and `repair`.id is not null and `repair`.repair_state in (1,2,3)</if>
        <if test="state != null  and state == 4">and (goods.state=4 or (goods.num > 0 and goods.damage_num > 0))</if>

        and goods.goods_name in
        <foreach collection="goodsNameList" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

        and goods.site_id in
        <foreach collection="siteIdList" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>

    </select>

    <select id="selectGoodsNameList" resultType="java.lang.String">
        select distinct goods_name
        from xf_wz_goods
        where goods_name is not null and goods_name != ''
        <if test="type != null and type != -1">
            and type_id = #{type}
        </if>

        <if test="goodsName != null and goodsName != '' and  goodsName != 'null' ">
            and goods_name like concat('%',#{goodsName},'%')
        </if>

    </select>

    <select id="selectCountByIds" resultType="java.lang.Integer">
        select count(1) from xf_wz_goods where id
        in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectSiteIdByIds" resultType="com.ruoyi.project.xf.domain.XfWzGoods">
        select id,site_id as siteId from xf_wz_goods where id
        in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectCarList" resultType="com.ruoyi.project.xcx.vo.NameIdVo">
        select id, `goods_name` as name, car_no as carNo, car_status as carStatus
        from xf_wz_goods
        where site_id = #{siteId}
          and car = 1
    </select>

    <select id="selectCarById" resultType="java.lang.Boolean">
        select count(1)
        from xf_wz_goods
        where site_id = #{siteId}
          and id = #{carId}
    </select>

    <select id="checkCarOut" resultType="java.lang.Boolean">
        select count(1)
        from xf_wz_goods
        where id = #{carId}
          and car_status = 1
    </select>

    <select id="selectNormalGoodsCountBySiteIds" resultType="java.lang.Long">
        select sum(goods.num - goods.damage_num)
        from xf_wz_goods as goods
        left outer join xf_wx_repair as repair
        on goods.id = repair.goods_id
        inner join xf_wz_type as type
        on type.id = goods.type_id
        where goods.site_id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
          and goods.car = 0
        and goods.state = 2 and (repair.available_flag is null or repair.available_flag != 2 )
        and type.is_fire_goods = 1
    </select>

    <select id="selectNormalCarCountBySiteIds" resultType="java.lang.Long">
        select sum(goods.num - goods.damage_num)
        from xf_wz_goods as goods
        left outer join xf_wx_repair as repair
        on goods.id = repair.goods_id
        where goods.site_id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and goods.state = 2 and (repair.available_flag is null or repair.available_flag != 2 )
        and goods.car = 1
    </select>

    <select id="selectGoodsCountBySiteIds" resultType="java.lang.Long">
        select sum(num) from xf_wz_goods as goods
        left outer join xf_wz_type as type
        on type.id = goods.type_id
        WHERE site_id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and goods.car = 0
        and state = 2
        and type.is_fire_goods = 1
    </select>

    <select id="selectCarCountBySiteIds" resultType="java.lang.Long">
        select sum(num) from xf_wz_goods where site_id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and car = 1
        and state = 2
    </select>

    <select id="selectCarStaInfoBySiteIds" resultType="com.ruoyi.project.xcx.vo.NameIdVo">
        select g.goods_name as name,s.site_name as siteName,g.car_no as carNo
        from xf_wz_goods as g
        left outer join xf_base_site as s
        on g.site_id = s.id
        where s.id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and car = 1
        and g.state = 2
    </select>

    <select id="selectGoodsStaInfoBySiteIds" resultType="com.ruoyi.project.xcx.vo.GoodsStaVo">
        select
        (goods.num - goods.damage_num) as normalCount,
        goods.goods_name as goodsName,site.site_name as siteName,
        goods.goods_code as goodsCode
        from xf_wz_goods as goods
        left outer join xf_wx_repair as repair
        on goods.id = repair.goods_id
        left outer join xf_base_site as site on site.id = goods.site_id
        inner join xf_wz_type as type
        on type.id = goods.type_id
        where goods.site_id in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        and goods.car = 0
        and goods.state = 2
        and (repair.available_flag is null or repair.available_flag != 2)
        and type.is_fire_goods = 1
    </select>

    <update id="updateXfWzGoods" parameterType="com.ruoyi.project.xf.domain.XfWzGoods">
        update xf_wz_goods
        <trim prefix="SET" suffixOverrides=",">
            <if test="goodsName != null  and goodsName != ''">goods_name = #{goodsName},</if>
            <if test="model != null  and model != ''">model = #{model},</if>
            <if test="num != null  and num != ''">num = #{num},</if>
            <if test="unit != null  and unit != ''">unit = #{unit},</if>
            <if test="getTime != null">get_time = #{getTime},</if>
            <if test="limitTime != null">limit_time = #{limitTime},</if>
            <if test="useTime != null ">use_time = #{useTime},</if>
            <if test="supplier != null  and supplier != ''">supplier = #{supplier},</if>
            <if test="manufactor != null  and manufactor != ''">manufactor = #{manufactor},</if>
            <if test="bz != null  and bz != ''">bz = #{bz},</if>
            <if test="state != null  and state != ''">state = #{state},</if>
            <if test="damageNum != null">damage_num = #{damageNum},</if>
        </trim>
        where id = #{id}
    </update>

    <update id="updateXfWzGoodsState" parameterType="XfWzGoods">
        update xf_wz_goods
        set state = #{state}
        where id = #{id}
    </update>

    <update id="unLock">
        unlock tables
    </update>

    <update id="readLockTable">
        lock
        table xf_wz_goods read
    </update>

    <update id="generator">
        insert into xf_wz_goods(goods_code, site_id, type_id, state)
        values
        <foreach collection="codes" item="code" separator=",">
            (#{code},#{siteId},#{typeId},1)
        </foreach>
    </update>

    <update id="updateDamageNum">
        update xf_wz_goods
        set damage_num = damage_num + #{damageNum},
            version    = version + 1
        where id = #{goodsId}
          and num >= damage_num + #{damageNum}
          and version = #{version}
    </update>

    <update id="markDamaged">
        update xf_wz_goods
        set damage_num = num,
            state      = 4
        where id = #{id}
    </update>

    <update id="markOut">
        update xf_wz_goods
        set car_status = 1
        where id = #{carId}
    </update>

    <update id="markCarReturn">
        update xf_wz_goods
        set car_status = 2
        where id = #{carId}
    </update>

    <delete id="deleteXfWzGoodsById" parameterType="Long">
        delete
        from xf_wz_goods
        where id = #{id}
    </delete>

    <delete id="deleteXfWzGoodsByIds" parameterType="String">
        delete from xf_wz_goods where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>