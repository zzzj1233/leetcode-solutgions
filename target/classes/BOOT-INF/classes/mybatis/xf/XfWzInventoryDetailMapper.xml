<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.xf.mapper.XfWzInventoryDetailMapper">

    <resultMap type="XfWzInventoryDetail" id="XfWzInventoryDetailResult">
        <result property="id" column="id"/>
        <result property="goodsId" column="goods_id"/>
        <result property="totalNum" column="total_num"/>
        <result property="realNum" column="real_num"/>
        <result property="updateTime" column="update_time"/>
        <result property="inventoryId" column="inventory_id"/>
        <result property="goodsName" column="goods_name"/>
        <result property="goodsCode" column="goods_code"/>
    </resultMap>

    <sql id="selectXfWzInventoryDetailVo">
        select id, goods_id, total_num, real_num, update_time, inventory_id
        from xf_wz_inventory_detail
    </sql>

    <sql id="selectXfWzInventoryGoodsDetailVo">
        select detail.id, detail.goods_id, detail.total_num, detail.real_num, detail.inventory_id, goods.goods_name, goods.goods_code
        from xf_wz_inventory_detail detail
                 LEFT JOIN xf_wz_goods goods ON goods.id = detail.goods_id
    </sql>

    <insert id="saveBatch" parameterType="XfWzInventoryDetail">
        insert into xf_wz_inventory_detail
        (goods_id,total_num,real_num,update_time,inventory_id)
        VALUES
        <foreach collection="inventoryDetailList" item="item" separator=",">
            (#{item.goodsId},#{item.totalNum},#{item.realNum},#{item.updateTime},#{item.inventoryId})
        </foreach>
    </insert>

    <select id="selectXfWzInventoryDetailList" parameterType="XfWzInventoryDetail" resultMap="XfWzInventoryDetailResult">
        <include refid="selectXfWzInventoryDetailVo"/>
        <where>
            <if test="goodsId != null ">and goods_id = #{goodsId}</if>
            <if test="totalNum != null ">and total_num = #{totalNum}</if>
            <if test="realNum != null ">and real_num = #{realNum}</if>
            <if test="inventoryId != null ">and inventory_id = #{inventoryId}</if>
        </where>
    </select>

    <resultMap id="XfWzInventoryDetailVoMap" type="com.ruoyi.project.xf.vo.output.XfWzInventoryDetailVo">
        <id property="id" column="id"/>
        <id property="inventoryTopicName" column="topic"/>
        <id property="goodsName" column="goods_name"/>
        <id property="goodsCode" column="goods_code"/>
        <id property="siteName" column="site_name"/>
        <id property="typeName" column="type_name"/>
        <id property="totalNum" column="total_num"/>
        <id property="realNum" column="real_num"/>
    </resultMap>

    <select id="selectXfWzInventoryDetailList2" parameterType="com.ruoyi.project.xf.vo.input.XfWzInventoryQueryInput" resultMap="XfWzInventoryDetailVoMap">
        select
        detail.id,
        detail.total_num,
        detail.real_num,
        inventory.topic,
        goods.goods_name,
        goods.goods_code,
        site.site_name,
        type.type_name
        from xf_wz_inventory_detail detail

        LEFT outer JOIN xf_wz_inventory inventory on inventory.id = detail.inventory_id
        left outer join xf_wz_goods as goods on goods.id = detail.goods_id
        left outer join xf_base_site as site on site.id = goods.site_id
        left outer join xf_wz_type as type on type.id = goods.type_id
        <where>
            <if test="topic != null  and topic != ''">inventory.topic like "%"#{topic}"%"</if>

            <if test="startTimeDate != null">
                and STR_TO_DATE(inventory.start_time,"%Y-%m-%d ") &gt;= #{startTimeDate}
            </if>

            <if test="endTimeDate != null">
                and STR_TO_DATE(inventory.end_time,"%Y-%m-%d ") &lt;= #{endTimeDate}
            </if>

            <if test="wxtypeId != null">inventory.wxtype_id = #{wxtypeId}</if>

            <if test="checkState == 0">and inventory.total_num = inventory.real_num</if>
            <if test="checkState == 1">and inventory.total_num &lt; inventory.real_num</if>
            <if test="checkState == 2">and inventory.total_num &gt; inventory.real_num</if>

        </where>

    </select>


    <select id="getWzInventoryWzList" resultMap="XfWzInventoryDetailResult">
        <include refid="selectXfWzInventoryGoodsDetailVo"/>
        where detail.inventory_id = #{inventoryId}
        LIMIT #{page},#{limit}
    </select>

    <select id="selectXfWzInventoryDetailById" parameterType="Long" resultMap="XfWzInventoryDetailResult">
        <include refid="selectXfWzInventoryDetailVo"/>
        where id = #{id}
    </select>

    <select id="queryByTopicAndState" resultMap="XfWzInventoryDetailResult">
        /* 1. 正常 */
        /* 2. 多盘 */
        /* 3. 少盘 */
        select ind.id as id, goods_id, ind.total_num as total_num, ind.real_num as real_num, ind.update_time as update_time, inventory_id
        from xf_wz_inventory_detail as ind
        inner join xf_wz_inventory as inv on ind.inventory_id = inv.id
        <where>
            inv.topic like concat("%",#{topic},"%")
            <if test="checkState == 1">
                and ind.total_num = ind.real_num
            </if>

            <if test="checkState == 2">
                and ind.total_num &gt; ind.real_num
            </if>

            <if test="checkState == 3">
                and ind.total_num &lt; ind.real_num
            </if>
        </where>
    </select>

    <select id="selectByCheckState" resultMap="XfWzInventoryDetailResult">
        /* 1. 正常 */
        /* 2. 多盘 */
        /* 3. 少盘 */
        <include refid="selectXfWzInventoryDetailVo"/>
        <where>
            <if test="_parameter == 1">
                total_num = real_num
            </if>

            <if test="_parameter == 2">
                total_num &gt; real_num
            </if>

            <if test="_parameter == 3">
                total_num &lt; real_num
            </if>
        </where>

    </select>

    <insert id="insertXfWzInventoryDetail" parameterType="XfWzInventoryDetail" useGeneratedKeys="true" keyProperty="id">
        insert into xf_wz_inventory_detail
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="goodsId != null ">goods_id,</if>
            <if test="totalNum != null ">total_num,</if>
            <if test="realNum != null ">real_num,</if>
            <if test="updateTime != null  and updateTime != ''">update_time,</if>
            <if test="inventoryId != null ">inventory_id,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="goodsId != null ">#{goodsId},</if>
            <if test="totalNum != null ">#{totalNum},</if>
            <if test="realNum != null ">#{realNum},</if>
            <if test="updateTime != null  and updateTime != ''">#{updateTime},</if>
            <if test="inventoryId != null ">#{inventoryId},</if>
        </trim>
    </insert>

    <update id="updateXfWzInventoryDetail" parameterType="XfWzInventoryDetail">
        update xf_wz_inventory_detail
        <trim prefix="SET" suffixOverrides=",">
            <if test="goodsId != null ">goods_id = #{goodsId},</if>
            <if test="totalNum != null ">total_num = #{totalNum},</if>
            <if test="realNum != null ">real_num = #{realNum},</if>
            <if test="updateTime != null  and updateTime != ''">update_time = #{updateTime},</if>
            <if test="inventoryId != null ">inventory_id = #{inventoryId},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteXfWzInventoryDetailById" parameterType="Long">
        delete
        from xf_wz_inventory_detail
        where id = #{id}
    </delete>

    <delete id="deleteXfWzInventoryDetailByIds" parameterType="String">
        delete from xf_wz_inventory_detail where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteByInventoryIds">
        delete from xf_wz_inventory_detail where inventory_id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>