<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.xf.mapper.XfKqSigninCalMapper">

    <resultMap type="XfKqSigninCal" id="XfKqSigninCalResult">
        <result property="id" column="id"/>
        <result property="customerId" column="customer_id"/>
        <result property="siteId" column="site_id"/>
        <result property="onworkTime" column="onwork_time"/>
        <result property="offworkTime" column="offwork_time"/>
        <result property="signinDate" column="signin_date"/>
        <result property="onworkState" column="onwork_state"/>
        <result property="offworkState" column="offwork_state"/>
        <result property="siteName" column="siteName"/>
    </resultMap>

    <sql id="selectXfKqSigninCalVo">
        select id,
               customer_id,
               site_id,
               onwork_time,
               offwork_time,
               signin_date,
               onwork_state,
               offwork_state
        from xf_kq_signin_cal
    </sql>

    <select id="selectAttendanceCal" resultType="com.ruoyi.project.xf.domain.AttendanceCal">
        SELECT sum(CASE WHEN onwork_state=3 THEN 0 ELSE 0.5 END) workday1,sum(CASE WHEN offwork_state=3 THEN 0 ELSE 0.5 END) workday2,
        sum(CASE WHEN onwork_state=2 THEN 1 ELSE 0 END) late_coming,sum(CASE WHEN offwork_state=2 THEN 1 ELSE 0 END) early_leave,
        sum(CASE WHEN onwork_state=3 OR offwork_state=3 THEN 1 ELSE 0 END) missing_signin
        from xf_kq_signin_cal
        <where>
            <if test="customerId != null and customerId != '' ">and customer_id = #{customerId}</if>
            <if test="siteId != null  and siteId != ''">and site_id = #{siteId}</if>
            <if test="siteArea != null  and siteArea != ''">and site_id in (SELECT id from xf_base_site where CONCAT(province,'-',city,'-',area,'-',street) like CONCAT(#{siteArea},'%')) </if>
            <if test="month != null  and month != ''">and signin_date LIKE concat( #{month}, '%')</if>
            <if test="startDay != null  and startDay != ''">and signin_date &gt;= #{startDay}</if>
            <if test="endDay != null  and endDay != '' ">and signin_date &lt;= #{endDay}</if>
        </where>
    </select>

    <select id="selectAttendanceCalDetail" resultType="com.ruoyi.project.xf.domain.AttendanceCalDetail">
        SELECT cal.*,customer.fullname from xf_kq_signin_cal cal LEFT JOIN xf_user_customer customer ON customer.id=cal.customer_id
        <where>
            <if test="customerId != null  and customerId != ''">and cal.customer_id = #{customerId}</if>
            <if test="siteId != null  and siteId != 0">and cal.site_id = #{siteId}</if>
            <if test="siteArea != null  and siteArea != ''">and cal.site_id in (SELECT id from xf_base_site where CONCAT(province,'-',city,'-',area,'-',street) like CONCAT(#{siteArea},'%')) </if>
            <if test="month != null and month != '' ">and cal.signin_date LIKE concat( #{month}, '%')</if>
            <if test="startDay != null  and startDay != ''">and cal.signin_date &gt;= #{startDay}</if>
            <if test="endDay != null  and endDay != ''">and cal.signin_date &lt;= #{endDay}</if>
            <if test="calType==3">and cal.onwork_state=2</if>
            <if test="calType==4">and cal.offwork_state=2</if>
            <if test="calType==5">and (cal.onwork_state=3 OR cal.offwork_state=3)</if>
        </where>
        ORDER BY cal.id DESC
    </select>

    <select id="selectAttendanceMonthDetail" resultType="com.ruoyi.project.xf.domain.AttendanceCalDetail">
        SELECT cal.* from xf_kq_signin_cal cal
        <where>
            <if test="customerId != null  and customerId != ''">and cal.customer_id = #{customerId}</if>
            <if test="siteId != null  and siteId != 0">and cal.site_id = #{siteId}</if>
            <if test="month != null and month != '' ">and cal.signin_date LIKE concat( #{month}, '%')</if>
            <if test="startDay != null  and startDay != ''">and cal.signin_date &gt;= #{startDay}</if>
            <if test="endDay != null  and endDay != ''">and cal.signin_date &lt;= #{endDay}</if>
            <if test="calType==3">and cal.onwork_state=2</if>
            <if test="calType==4">and cal.offwork_state=2</if>
            <if test="calType==5">and (cal.onwork_state=3 OR cal.offwork_state=3)</if>
        </where>
        ORDER BY cal.id DESC
    </select>

    <sql id="selectXfKqSigninCalWeb">
        select signinCal.id,
               signinCal.customer_id,
               signinCal.site_id,
               signinCal.onwork_time,
               signinCal.offwork_time,
               signinCal.signin_date,
               signinCal.onwork_state,
               signinCal.offwork_state,
               customer.fullname    as customerName,
               customer.mobilephone AS customerMobile,
               site.site_name       as siteName
        from xf_kq_signin_cal signinCal
                 LEFT JOIN xf_user_customer customer ON customer.id = signinCal.customer_id
                 LEFT JOIN xf_base_site site ON site.id = signinCal.site_id
    </sql>

    <select id="selectXfKqSigninCalList" parameterType="XfKqSigninCal" resultMap="XfKqSigninCalResult">
        <include refid="selectXfKqSigninCalWeb"/>
        <where>
            <if test="customerId != null and endDay!='' ">and signinCal.customer_id = #{customerId}</if>
            <if test="siteId != null and siteId!=0">and signinCal.site_id = #{siteId}</if>
            <if test="onworkTime != null and onworkTime!=''">and signinCal.onwork_time = #{onworkTime}</if>
            <if test="offworkTime != null and offworkTime!=''">and signinCal.offwork_time = #{offworkTime}</if>
            <if test="signinDate != null and signinDate!=''">and signinCal.signin_date = #{signinDate}</if>
            <if test="onworkState != null and onworkState!=0">and signinCal.onwork_state = #{onworkState}</if>
            <if test="offworkState != null and offworkState!=0">and signinCal.offwork_state = #{offworkState}</if>
            <if test="signState != null and signState==1">and signinCal.offwork_state = 1 and signinCal.onwork_state = 1</if>
            <if test="signState != null and signState==2">and (signinCal.offwork_state != 1 or signinCal.onwork_state != 1)</if>
            <if test="customerName != null and customerName.trim()!='' ">and customer.fullname LIKE concat(concat('%',#{customerName}),'%')</if>
            <if test="siteName != null and siteName.trim()!='' ">and site.site_name LIKE concat(concat('%',#{siteName}),'%')</if>
        </where>
        ORDER BY signinCal.id DESC
    </select>


    <select id="selectXfKqSigninCalById" parameterType="Long" resultMap="XfKqSigninCalResult">
        <include refid="selectXfKqSigninCalWeb"/>
        where signinCal.id = #{id}
    </select>

    <insert id="insertXfKqSigninCal" parameterType="XfKqSigninCal" useGeneratedKeys="true" keyProperty="id">
        insert into xf_kq_signin_cal
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="customerId != null ">customer_id,</if>
            <if test="siteId != null ">site_id,</if>
            <if test="onworkTime != null ">onwork_time,</if>
            <if test="offworkTime != null ">offwork_time,</if>
            <if test="signinDate != null ">signin_date,</if>
            <if test="onworkState != null ">onwork_state,</if>
            <if test="offworkState != null ">offwork_state,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="customerId != null ">#{customerId},</if>
            <if test="siteId != null ">#{siteId},</if>
            <if test="onworkTime != null ">#{onworkTime},</if>
            <if test="offworkTime != null ">#{offworkTime},</if>
            <if test="signinDate != null ">#{signinDate},</if>
            <if test="onworkState != null ">#{onworkState},</if>
            <if test="offworkState != null ">#{offworkState},</if>
        </trim>
    </insert>

    <update id="updateXfKqSigninCal" parameterType="XfKqSigninCal">
        update xf_kq_signin_cal
        <trim prefix="SET" suffixOverrides=",">
            <if test="customerId != null ">customer_id = #{customerId},</if>
            <if test="siteId != null ">site_id = #{siteId},</if>
            <if test="onworkTime != null ">onwork_time = #{onworkTime},</if>
            <if test="offworkTime != null ">offwork_time = #{offworkTime},</if>
            <if test="signinDate != null ">signin_date = #{signinDate},</if>
            <if test="onworkState != null ">onwork_state = #{onworkState},</if>
            <if test="offworkState != null ">offwork_state = #{offworkState},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteXfKqSigninCalById" parameterType="Long">
        delete
        from xf_kq_signin_cal
        where id = #{id}
    </delete>

    <delete id="deleteXfKqSigninCalByIds" parameterType="String">
        delete from xf_kq_signin_cal where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>